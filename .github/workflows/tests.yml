name: Tests

on:
  push:
    branches: [ main, develop, feature/port-3000-default ]
  pull_request:
    branches: [ main, develop, feature/port-3000-default ]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_DB: agent_mcp
          POSTGRES_USER: agent_mcp
          POSTGRES_PASSWORD: agent_mcp_password
        options: >-
          --health-cmd pg_isready -U agent_mcp
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install uv
      run: pip install uv
    
    - name: Install dependencies
      run: uv pip install --system -e ".[dev]"
    
    - name: Set up environment variables
      run: |
        echo "AGENT_MCP_DB_HOST=localhost" >> $GITHUB_ENV
        echo "AGENT_MCP_DB_PORT=5432" >> $GITHUB_ENV
        echo "AGENT_MCP_DB_NAME=agent_mcp" >> $GITHUB_ENV
        echo "AGENT_MCP_DB_USER=agent_mcp" >> $GITHUB_ENV
        echo "AGENT_MCP_DB_PASSWORD=agent_mcp_password" >> $GITHUB_ENV
        echo "EMBEDDING_PROVIDER=openai" >> $GITHUB_ENV
        echo "AGENT_MCP_API_PORT=8080" >> $GITHUB_ENV
        echo "AGENT_MCP_DASHBOARD_PORT=3001" >> $GITHUB_ENV
    
    - name: Install PostgreSQL client
      run: sudo apt-get update && sudo apt-get install -y postgresql-client
    
    - name: Wait for PostgreSQL
      run: |
        until pg_isready -h localhost -p 5432 -U agent_mcp; do
          echo "Waiting for PostgreSQL..."
          sleep 1
        done
    
    - name: Initialize database schema
      run: |
        python3 -c "from agent_mcp.db.postgres_schema import init_database; init_database()"
    
    - name: Run tests with coverage
      id: test_coverage
      run: |
        uv run pytest tests/ --ignore=tests/benchmarks --cov=agent_mcp --cov-report=xml --cov-report=html --cov-report=term -v --tb=short | tee pytest_output.txt
        # Extract test statistics
        PASSED=$(grep -oP '\d+(?=\s+passed)' pytest_output.txt | head -1 || echo "0")
        FAILED=$(grep -oP '\d+(?=\s+failed)' pytest_output.txt | head -1 || echo "0")
        SKIPPED=$(grep -oP '\d+(?=\s+skipped)' pytest_output.txt | head -1 || echo "0")
        TOTAL=$(grep -oP '\d+(?=\s+passed)' pytest_output.txt | head -1 || echo "0")
        echo "passed=$PASSED" >> $GITHUB_OUTPUT
        echo "failed=$FAILED" >> $GITHUB_OUTPUT
        echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
        echo "total=$TOTAL" >> $GITHUB_OUTPUT
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'sk-test123456789012345678901234567890' }}
        EMBEDDING_PROVIDER: ollama
    
    - name: Update README with test stats
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        python3 scripts/update-test-badges.py < pytest_output.txt || echo "Failed to update README stats"
        if git diff --quiet README.md; then
          echo "No changes to README.md"
        else
          git add README.md
          git commit -m "docs: Update test statistics in README [skip ci]" || echo "No changes to commit"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git push origin HEAD:main || echo "Failed to push README update"
        fi
      continue-on-error: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Comment PR with test results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const passed = '${{ steps.test_coverage.outputs.passed }}';
          const failed = '${{ steps.test_coverage.outputs.failed }}';
          const skipped = '${{ steps.test_coverage.outputs.skipped }}';
          const total = '${{ steps.test_coverage.outputs.total }}';
          
          // Determine status emoji
          let statusEmoji = '✅';
          if (failed !== '0' && failed !== '' && parseInt(failed) > 0) {
            statusEmoji = '❌';
          } else if (skipped !== '0' && skipped !== '' && parseInt(skipped) > parseInt(total) * 0.1) {
            statusEmoji = '⚠️';
          }
          
          const body = `## Test Results ${statusEmoji}\n\n` +
            `- **Total Tests:** ${total || 'N/A'}\n` +
            `- **Passed:** ${passed || '0'} ✅\n` +
            `- **Failed:** ${failed || '0'}${failed !== '0' && failed !== '' ? ' ❌' : ''}\n` +
            `- **Skipped:** ${skipped || '0'}\n\n` +
            `[View full test logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

